name: Authorization

on:
    push:
        branches:
            - dev
    pull_request:
        types:
            - synchronize

jobs:
    build:
        name: Build and Deploy
        runs-on: ubuntu-latest
        steps:
            - name: Check if repository is a fork
              id: check_fork
              run: echo "::set-output name=is_fork::${{ github.event.repository.fork }}"

            - name: Executing remote SSH commands using key
              if: steps.check_fork.outputs.is_fork == 'true'
              uses: appleboy/ssh-action@v1.2.2
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.KEY }}
                  port: ${{ secrets.PORT }}
                  script: |
                      cd /home/vdobrovolskyi/watchtogether.fun
                      echo "üîÑ C—Ç—è–≥–∏–≤–∞–µ–º –∫–æ–¥ —Å github"
                      echo "üóë –û—á–∏—â–∞–µ–º —Å–ª–µ–¥—ã –ø—Ä–æ—à–ª—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤, –µ—Å–ª–∏ –∏–º–µ—é—Ç—Å—è"
                      if [ -d "streaming-auth" ]; then
                          rm -rf streaming-auth
                      fi
                      git clone git@github.com:VladyslavDobrovolskyi/streaming-auth.git
                      cd streaming-auth
                      git checkout dev
                      git pull
                      rm -rf .git

                      echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
                      echo "üõë –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ streaming-auth"
                      if [ $(docker ps -q -f name=streaming-auth) ]; then
                          echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ streaming-auth"
                          docker stop streaming-auth || true
                          docker rm streaming-auth || true
                      fi

                      echo "üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—Ä–∞–∑–∞ streaming-auth, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                      if [ $(docker images -q streaming-auth) ]; then
                          docker rmi streaming-auth || true
                      fi

                      echo "üõ† –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ streaming-auth –±–µ–∑ –∫—ç—à–∞"
                      docker build -t streaming-auth .

                      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–µ—Ç–∏ watchtogether-network"
                      if [ ! $(docker network ls -q -f name=watchtogether-network) ]; then
                          echo "üåê –°–µ—Ç—å watchtogether-network –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º —Å–µ—Ç—å"
                          docker network create watchtogether-network
                      fi

                      echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ streaming-auth"
                      docker run -d --name streaming-auth \
                        --network watchtogether-network \
                        --restart always \
                        -p 5555:5555 \
                        streaming-auth

                      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä streaming-auth –ø–æ–¥–Ω—è–ª—Å—è"
                      if [ $(docker ps -q -f name=streaming-auth) ]; then
                          echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä streaming-auth —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
                      else
                          echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä streaming-auth –Ω–µ –∑–∞–ø—É—â–µ–Ω"
                          exit 1
                      fi

                      cd /home/ubuntu/

                      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ postgres –∏ nginx"
                      if [ ! $(docker ps -q -f name=postgres) ]; then
                          echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä postgres –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º docker-compose up"
                          docker-compose up -d postgres
                      fi
                      if [ ! $(docker ps -q -f name=nginx) ]; then
                          echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä nginx –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º docker-compose up"
                          docker-compose up -d nginx
                      fi

                      echo "üóë –û—á–∏—â–∞–µ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ"
                      if [ -d "streaming-auth" ]; then
                          rm -rf streaming-auth
                      fi

                      echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
